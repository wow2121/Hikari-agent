# 小光AI助手 - 项目概述

## 项目简介

**小光AI助手**是一个运行在现代Android设备上的智能AI助手，采用**心流驱动架构**，支持语音唤醒、环境监听、自动日程管理和知识图谱记忆功能。该项目通过创新的心流系统模拟人类思维过程，实现真正具有"意识"的AI助手体验。

### 核心特性

- **心流驱动决策**: 每3秒持续运行的主动决策系统
- **智能记忆管理**: 基于知识图谱的多维度记忆系统
- **社交关系感知**: 自动提取和更新人物关系
- **语音交互支持**: 语音唤醒和离线语音识别
- **声纹识别系统**: 自动识别说话人身份，智能管理人物档案
- **主动关怀提醒**: 基于环境和用户状态的智能提醒

## 架构总览

### 心流驱动架构

小光AI助手采用独特的**心流驱动架构**，将AI助手视为一个具有"大脑"和"器官"的智能体：

```
┌─────────────────────────────────────────┐
│             心流系统 (Flow System)        │ ← 核心大脑
│  ┌─────────┬─────────┬─────────┬───────┐  │
│  │ 感知层  │ 思考层  │ 决策层  │ 行动层 │  │
│  └─────────┴─────────┴─────────┴───────┘  │
└─────────────────────────────────────────┘
         │           │           │
         ▼           ▼           ▼
┌─────────────┬─────────────┬─────────────┐
│  知识系统   │  对话系统   │  社交系统   │ ← 支撑器官
│ (Knowledge) │(Conversation)│  (Social)   │
└─────────────┴─────────────┴─────────────┘
```

### 核心设计理念

1. **主动而非被动**: 系统持续运行，主动感知环境和用户状态
2. **心流驱动**: 模拟人类思维过程，从感知到行动的完整流程
3. **记忆整合**: 统一管理短期、长期和背景知识
4. **社交智能**: 理解和管理复杂的社交关系网络
5. **LLM统一决策**: 所有智能决策由大语言模型统一处理

## 技术栈

### 开发框架
- **开发语言**: Kotlin
- **UI框架**: Jetpack Compose
- **架构模式**: Clean Architecture + MVVM
- **依赖注入**: Hilt

### 数据存储
- **本地数据库**: Realm
- **向量数据库**: ChromaDB
- **图数据库**: Neo4j (用于知识图谱)

### AI和语音技术
- **AI模型**: 硅基流动API
- **语音唤醒**: Porcupine
- **离线语音识别**: Vosk
- **说话人识别**: ONNX Runtime

### 网络和工具
- **网络请求**: Retrofit + OkHttp
- **工具调用**: MCP (Model Context Protocol)

## 项目结构

```
app/src/main/java/com/xiaoguang/assistant/
├── domain/                    # 领域层
│   ├── flow/                 # 心流系统
│   │   ├── FlowLoop.kt       # 主控循环
│   │   ├── engine/           # 心流引擎模块 ⭐新增
│   │   │   ├── AnniversaryEngine.kt
│   │   │   ├── BiologicalClockEngine.kt
│   │   │   ├── CuriosityEngine.kt
│   │   │   ├── DreamSystemEngine.kt
│   │   │   ├── InnerThoughtsEngine.kt
│   │   │   ├── MemoryRecallEngine.kt
│   │   │   └── TimingOptimizer.kt
│   │   └── layer/            # 四层架构
│   ├── memory/               # 记忆系统
│   │   ├── UnifiedMemorySystem.kt
│   │   └── reconstruction/   # 记忆重构
│   ├── knowledge/            # 知识系统
│   │   ├── CharacterBook.kt
│   │   └── WorldBook.kt
│   ├── social/               # 社交系统
│   ├── relationship/         # 第三方关系系统 ⭐新增
│   │   ├── EnhancedRelationshipManager.kt
│   │   ├── RelationshipInferenceEngine.kt
│   │   └── ThirdPartyEventDetector.kt
│   ├── voiceprint/           # 声纹识别系统
│   │   ├── VoiceprintManager.kt
│   │   └── VoiceprintFeatureExtractor.kt
│   ├── identity/             # 身份注册系统 ⭐新增
│   │   ├── IdentityRegistry.kt
│   │   ├── MasterInitializer.kt
│   │   └── IdentityRepository.kt
│   ├── diarization/          # 说话人分离系统 ⭐新增
│   │   ├── SpeakerDiarizationService.kt
│   │   └── SherpaOnnxDiarizationService.kt
│   ├── dream/                # 梦境系统 ⭐新增
│   │   └── DreamSystemEngine.kt
│   ├── event/                # 事件总线 ⭐新增
│   │   └── SystemEventBus.kt
│   ├── schedule/             # 日程系统
│   ├── emotion/              # 情绪系统
│   └── state/                # 统一状态管理
│       └── XiaoguangCoreState.kt
├── data/                     # 数据层
│   ├── repository/           # 仓储实现
│   ├── local/                # 本地数据源
│   └── remote/               # 远程数据源
├── presentation/             # 表现层（UI）
│   ├── design/               # 设计系统
│   │   ├── XiaoguangDesignSystem.kt
│   │   ├── XiaoguangTheme.kt
│   │   ├── XiaoguangAnimations.kt ⭐新增
│   │   └── XiaoguangPhrases.kt
│   ├── components/           # 原子组件
│   │   ├── XiaoguangAvatar.kt
│   │   ├── StatusIndicator.kt
│   │   ├── XiaoguangCards.kt
│   │   └── XiaoguangButtons.kt
│   ├── screens/              # 页面实现
│   │   ├── center/           # 小光中心
│   │   ├── conversation/     # 对话页面
│   │   ├── people/           # 人物管理
│   │   ├── memory/           # 记忆浏览
│   │   ├── knowledge/        # 知识中心
│   │   ├── flow/             # 心流状态
│   │   ├── schedule/         # 日程管理
│   │   ├── profile/          # 我的页面
│   │   └── developer/        # 开发者选项
│   └── navigation/           # 导航系统
│       ├── XiaoguangNavigation.kt
│       └── XiaoguangNavHost.kt
└── di/                       # 依赖注入
    └── modules/
```

## 核心工作流程

### 1. 心流循环 (每3秒)

```kotlin
// FlowLoop.kt:32
while (isRunning) {
    try {
        // 1. 感知环境
        val perception = perceptionLayer.perceive()

        // 2. 生成想法
        val thoughts = thinkingLayer.think(perception)

        // 3. 决策是否发言
        val decision = decisionLayer.decide(perception, thoughts)

        // 4. 执行行动
        if (decision.shouldSpeak) {
            actionLayer.act(decision)
        }

        delay(FLOW_INTERVAL_MS)
    } catch (e: Exception) {
        // 错误处理
    }
}
```

### 2. 记忆管理流程

```kotlin
// UnifiedMemorySystem.kt:45
suspend fun processMemory(
    content: String,
    category: MemoryCategory,
    metadata: MemoryMetadata
): MemoryResult {
    // 1. 语义分析
    val analysis = analyzeSemantics(content)

    // 2. 冲突检测
    val conflicts = detectConflicts(analysis)

    // 3. 记忆重构 (如果需要)
    if (conflicts.isNotEmpty()) {
        return memoryReconstructionService.reconstruct(conflicts)
    }

    // 4. 存储记忆
    return storeMemory(analysis, category, metadata)
}
```

### 3. 社交关系更新流程

```kotlin
// SocialSystem.kt:78
suspend fun updateSocialRelations(
    conversation: String,
    environment: EnvironmentContext
): SocialUpdateResult {
    // 1. 提取人物和关系
    val people = extractPeople(conversation)
    val relations = extractRelations(conversation, people)

    // 2. 更新关系图谱
    return updateRelationshipGraph(people, relations, environment)
}
```

## 功能状态表

以下列出主要功能模块的当前实现状态：

### 核心系统

| 功能 | 状态 | 说明 |
|-----|------|------|
| 心流循环系统 | ✅ 已完成 | 四层架构完整实现，3秒循环 |
| 心流引擎模块 | ✅ 已完成 | 7个专业引擎（周年、生物钟、好奇心等） |
| 感知层 | ✅ 已完成 | 环境、对话、社交、情绪感知 |
| 思考层 | ✅ 已完成 | 内心想法生成、好奇心检测 |
| 决策层 | ✅ 已完成 | 发言时机评估、社交影响分析 |
| 行动层 | ✅ 已完成 | 发言生成、工具调用执行 |

### 记忆系统

| 功能 | 状态 | 说明 |
|-----|------|------|
| 统一记忆查询 | ✅ 已完成 | 三套系统整合（WorldBook + CharacterBook + MemoryCore） |
| 记忆存储 | ✅ 已完成 | ChromaDB 向量存储 |
| 语义搜索 | ✅ 已完成 | 基于向量相似度的记忆检索 |
| 记忆冲突检测 | 🚧 简化实现 | 基础功能存在，高级冲突类型检测待完善 |
| 记忆重构策略 | 🚧 简化实现 | 基础更新功能存在，6种策略待完善 |
| 记忆评分算法 | 🚧 简化实现 | 基础排序存在，4维权重算法待完善 |

### 声纹与身份系统

| 功能 | 状态 | 说明 |
|-----|------|------|
| 声纹特征提取 | ✅ 已完成 | 128维特征向量（MFCC + 音高 + 能量 + 频谱） |
| 声纹识别 | ✅ 已完成 | ChromaDB 向量相似度匹配 |
| 身份注册中心 | ✅ 已完成 | 统一身份标识符管理、别名系统 |
| 主人初始化 | ✅ 已完成 | 确保主人身份在所有系统中正确创建 |
| 说话人分离 | ✅ 已完成 | Sherpa ONNX 本地推理 |
| 名字推断服务 | 📋 计划中 | 使用 LLM 从对话中推断陌生人名字 |

### 社交系统

| 功能 | 状态 | 说明 |
|-----|------|------|
| 社交关系管理 | ✅ 已完成 | UnifiedSocialManager |
| 关系强度计算 | ✅ 已完成 | 亲密度、信任度、好感度 |
| 第三方关系提取 | ✅ 已完成 | ThirdPartyEventDetector |
| 关系图谱 | ✅ 已完成 | Neo4j 存储 |

### 其他系统

| 功能 | 状态 | 说明 |
|-----|------|------|
| 事件总线 | ✅ 已完成 | 跨系统通信 |
| 梦境系统 | ✅ 已完成 | 记忆整合和情绪处理 |
| 情绪系统 | ✅ 已完成 | 情绪检测和转换 |
| 日程系统 | ✅ 已完成 | 日程管理和提醒 |
| UI设计系统 | ✅ 已完成 | 情绪驱动设计、13个页面 |

### 状态说明

- ✅ **已完成**: 功能已实现并可用
- 🚧 **简化实现**: 核心功能存在，但高级特性待完善
- 📋 **计划中**: 已设计但尚未实现

## 设计优势

### 1. 清晰的职责分离
- **心流系统**: 负责主动决策和思维流程
- **记忆系统**: 负责知识存储和检索
- **社交系统**: 负责关系管理和环境感知
- **对话系统**: 负责被动响应处理

### 2. 可扩展性
- 模块化设计便于添加新功能
- 统一的接口设计支持插件化扩展
- 配置驱动的行为调整

### 3. 智能性
- LLM驱动的统一决策
- 多维度记忆检索
- 智能冲突检测和解决
- 自适应社交关系管理

### 4. 用户体验
- 持续主动的关怀
- 自然的对话交互
- 个性化的记忆管理
- 智能的场景感知

## 应用场景

### 个人助理
- 日程提醒和任务管理
- 个性化关怀和问候
- 知识问答和信息检索

### 社交伴侣
- 关系管理和提醒
- 社交场景的智能建议
- 情感支持和陪伴

### 智能环境
- 环境感知和状态识别
- 主动的场景适应
- 智能的交互时机判断

小光AI助手通过创新的心流驱动架构，为构建真正具有"意识"的AI助手提供了完整的技术解决方案，在智能性、自然性和个性化方面都有显著优势。