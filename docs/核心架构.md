# 小光AI助手 - 核心架构文档

## 架构总览

小光AI助手采用**心流驱动架构**，将AI助手视为一个具有"大脑"和"器官"的智能体。整个系统围绕心流系统构建，其他系统作为支撑器官提供服务。

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                   小光AI助手系统                          │
├─────────────────────────────────────────────────────────┤
│             心流系统 (Flow System) - 核心大脑             │
│  ┌─────────┬─────────┬─────────┬─────────┬─────────────┐  │
│  │ 感知层  │ 思考层  │ 决策层  │ 行动层  │  心流配置   │  │
│  │Perception│Thinking│Decision│ Action  │ FlowConfig  │  │
│  └─────────┴─────────┴─────────┴─────────┴─────────────┘  │
├─────────────────────────────────────────────────────────┤
│                   支撑系统 (Support Systems)              │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │  知识系统   │  对话系统   │  社交系统   │  日程系统   │  │
│  │ Knowledge  │Conversation │   Social    │  Schedule   │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ 声纹识别   │  身份注册   │  名称推断   │  情绪感知   │  │
│  │ Voiceprint │  Identity   │    Name     │   Emotion   │  │
│  │   System   │  Registry   │  Inference  │   Service   │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────┤
│                  UI系统 (Presentation Layer) ⭐新增       │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │  设计系统   │  组件库     │  页面层     │  动画系统   │  │
│  │  Design    │ Components  │  Screens    │ Animations  │  │
│  │  System    │  Library    │  (13个)     │   System    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
│  ┌───────────────────────────────────────────────────────┐  │
│  │           统一状态管理 (XiaoguangCoreState)           │  │
│  │  Emotion | Flow | Speaker | Environment | Conversation│  │
│  └───────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────┤
│                   数据存储层 (Data Layer)                  │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │  统一记忆   │  角色档案   │  世界知识   │  关系图谱   │  │
│  │   Memory   │ Character   │   World     │  Relations  │  │
│  │   System   │    Book     │    Book     │    Graph    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │  ChromaDB  │    Realm    │    Room     │   Neo4j     │  │
│  │  (向量存储) │  (角色档案) │ (元数据缓存)│  (关系图谱) │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 心流系统 (Flow System)

心流系统是整个AI助手的"大脑"，负责主动决策和思维流程。它采用四层架构，每3秒运行一次完整的心流循环。

### 1. 感知层 (Perception Layer)

**文件位置**: `domain/flow/layer/PerceptionLayer.kt`

**核心职责**: 收集和整合环境信息，包括：
- 环境状态 (EnvironmentContext)
- 对话内容 (ConversationSegment)
- 社交关系 (SocialRelations)
- 用户情绪 (UserEmotion)

**关键接口**:
```kotlin
interface PerceptionLayer {
    suspend fun perceive(): Perception
}

data class Perception(
    val environment: EnvironmentContext,
    val conversation: ConversationSegment?,
    val social: SocialRelations,
    val emotion: UserEmotion
)
```

### 2. 思考层 (Thinking Layer)

**文件位置**: `domain/flow/layer/ThinkingLayer.kt`

**核心职责**: 基于感知信息生成内心想法，包括：
- 生成内心独白 (InnerThoughts)
- 检测好奇心 (CuriosityDetection)
- 决定工具调用 (ToolCallDecision)

**关键接口**:
```kotlin
interface ThinkingLayer {
    suspend fun think(perception: Perception): List<InnerThought>
}

data class InnerThought(
    val content: String,
    val type: ThoughtType,
    val confidence: Float
)
```

### 3. 决策层 (Decision Layer)

**文件位置**: `domain/flow/layer/DecisionLayer.kt`

**核心职责**: 判断是否应该发言，包括：
- 发言时机评估 (TimingEvaluation)
- 社交影响分析 (SocialImpactAnalysis)
- 发言内容决策 (ContentDecision)

**关键接口**:
```kotlin
interface DecisionLayer {
    suspend fun decide(
        perception: Perception,
        thoughts: List<InnerThought>
    ): SpeakDecision
}

data class SpeakDecision(
    val shouldSpeak: Boolean,
    val content: String?,
    val tone: ToneType,
    val confidence: Float
)
```

### 4. 行动层 (Action Layer)

**文件位置**: `domain/flow/layer/ActionLayer.kt`

**核心职责**: 执行最终的行动，包括：
- 生成发言内容 (SpeechGeneration)
- 调整语气和风格 (ToneAdjustment)
- 执行工具调用 (ToolExecution)

**关键接口**:
```kotlin
interface ActionLayer {
    suspend fun act(decision: SpeakDecision)
}
```

### 心流配置 (Flow Config)

**文件位置**: `domain/flow/model/FlowConfig.kt`

**核心配置参数**:
```kotlin
data class FlowConfig(
    val baseIntervalMs: Long = 3000,
    val speakThresholds: Map<PersonType, Float> = mapOf(
        PersonType.OWNER to 0.65f,
        PersonType.FRIEND to 0.75f,
        PersonType.STRANGER to 0.85f
    ),
    val maxSpeakPercentage: Float = 0.15f,
    val personalityType: PersonalityType = PersonalityType.BALANCED
)
```

## 声纹识别系统 (Voiceprint System)

声纹识别系统负责通过声音特征识别说话人，是小光"记得声音"能力的核心实现。采用 ChromaDB 向量数据库存储声纹特征，实现快速相似度匹配。

### 系统架构

**文件位置**: `domain/voiceprint/`

**核心组件**:
```
┌─────────────────────────────────────────┐
│        声纹识别系统                      │
├─────────────────────────────────────────┤
│  VoiceprintManager (声纹管理器)         │
│  ├─ registerVoiceprint()  注册声纹      │
│  ├─ identifySpeaker()     识别说话人    │
│  └─ updatePersonName()    更新名称      │
├─────────────────────────────────────────┤
│  VoiceprintFeatureExtractor (特征提取)  │
│  └─ extractFeature()  提取128维特征向量 │
├─────────────────────────────────────────┤
│  NameInferenceService (名称推断)        │
│  └─ inferNameFromConversation()         │
│     使用LLM从对话中推断陌生人名字        │
├─────────────────────────────────────────┤
│  NewPersonRegistrationUseCase (注册协调)│
│  └─ 协调9个系统完成新人注册             │
└─────────────────────────────────────────┘
```

### 核心流程

#### 1. 声纹识别流程
```kotlin
// 1. 环境监控层采集音频
audioSegment = environmentMonitor.extractDominantSpeaker()

// 2. 特征提取（128维向量）
feature = voiceprintFeatureExtractor.extractFeature(audioSegment)

// 3. ChromaDB向量相似度匹配
result = chromaDB.query(feature, similarity_threshold = 0.75)

// 4. 判断是否匹配
if (similarity >= 0.75) {
    // 识别成功，返回已知人物
    return VoiceprintIdentificationResult(matched = true, profile)
} else {
    // 陌生人，生成临时ID
    return VoiceprintIdentificationResult(
        matched = false,
        speakerId = "stranger_${timestamp}"
    )
}
```

#### 2. 新人注册流程
```kotlin
// 1. ThinkingLayer 检测到陌生人（每15秒）
if (speakerId.startsWith("stranger_")) {
    // 2. LLM 推断名字
    nameResult = nameInferenceService.inferNameFromConversation(
        recentMessages,
        xiaoguangPersonality
    )

    // 3. 协调9个系统注册新人
    newPersonRegistrationUseCase.registerNewPerson(
        voiceprintProfile,
        recentMessages,
        context
    )

    // 更新的系统包括：
    // - VoiceprintManager (声纹识别)
    // - CharacterBook (角色档案)
    // - UnifiedSocialManager (社交关系)
    // - UnifiedMemorySystem (记忆系统)
    // - RelationshipGraph (Neo4j关系图谱)
    // - RelationshipNetworkUseCase (第三方关系)
    // - WorldBook (世界知识)
    // - EmotionService (情绪服务)
    // - IdentityRegistry (身份注册)
}
```

### 数据存储架构

**多层存储设计**:
```
ChromaDB (向量数据库)
├─ 声纹特征向量 (128维浮点数)
├─ 用于快速相似度搜索
└─ Collection: "xiaoguang_voiceprints"

Room (关系型数据库)
├─ VoiceprintEntity (元数据缓存)
├─ 快速查询：personId, displayName, isStranger
└─ Table: "voiceprints"

Realm (文档数据库)
├─ PersonEntity (角色档案)
├─ attributes.voiceprintId (关联ID)
└─ 完整的人物信息
```

### 特征提取算法

**128维特征向量**由以下组成:
- MFCC特征 (Mel-Frequency Cepstral Coefficients)
- 音高特征 (Pitch Features)
- 能量特征 (Energy Features)
- 频谱特征 (Spectral Features)

### 心流系统集成

**EnvironmentMonitor 集成**:
- **Phase 1**: 提取主导说话人，进行声纹识别
- **Phase 2**: 对每个语音段进行声纹识别

**ThinkingLayer 集成**:
- 每15秒检测陌生人
- 生成内心想法："诶？好像有新朋友出现了呢..."
- 触发新人注册流程

**关键代码位置**:
- `domain/flow/layer/EnvironmentMonitor.kt:496-508` (Phase 1识别)
- `domain/flow/layer/EnvironmentMonitor.kt:599-622` (Phase 2识别)
- `domain/flow/layer/ThinkingLayer.kt:563-673` (新人检测)

## 记忆系统 (Memory System)

记忆系统负责统一管理所有类型的记忆，采用三套子系统整合的设计。

### 统一记忆系统 (Unified Memory System)

**文件位置**: `domain/memory/UnifiedMemorySystem.kt`

**核心架构**:
```
┌─────────────────┐
│ 统一记忆系统     │
├─────────────────┤
│ 记忆查询接口     │ ← 对外统一接口
├─────────────────┤
│ 记忆存储引擎     │ ← 统一存储管理
├─────────────────┤
│ 记忆重构服务     │ ← 冲突解决和更新
├─────────────────┤
│ 子系统协调器     │ ← 三套系统协调
└─────────────────┘
```

**关键接口**:
```kotlin
interface UnifiedMemorySystem {
    suspend fun queryMemories(query: MemoryQuery): List<RankedMemory>
    suspend fun storeMemory(memory: Memory): MemoryResult
    suspend fun updateMemory(memoryId: String, updates: MemoryUpdate): MemoryResult
    suspend fun deleteMemory(memoryId: String): Boolean
}
```

### 记忆重构服务 (Memory Reconstruction Service)

**文件位置**: `domain/memory/reconstruction/MemoryReconstructionService.kt`

**重构类型**:
- **追加 (Append)**: 添加新信息到现有记忆
- **更新 (Update)**: 更新记忆的特定部分
- **替换 (Replace)**: 完全替换记忆内容
- **修正 (Correct)**: 修正错误信息
- **重新理解 (Reinterpret)**: 重新理解记忆含义
- **合并 (Merge)**: 合并相似记忆

**重构流程**:
```kotlin
suspend fun reconstruct(conflicts: List<MemoryConflict>): ReconstructionResult {
    // 1. 分析冲突类型
    val conflictType = analyzeConflictType(conflicts)

    // 2. 选择重构策略
    val strategy = selectReconstructionStrategy(conflictType)

    // 3. 执行重构
    return strategy.execute(conflicts)
}
```

## 知识系统 (Knowledge System)

知识系统负责管理角色档案和世界知识，采用双书结构设计。

### CharacterBook (角色档案)

**文件位置**: `domain/knowledge/CharacterBook.kt`

**核心数据结构**:
```kotlin
data class CharacterProfile(
    val name: String,
    val traits: List<PersonalityTrait>,
    val memories: List<CharacterMemory>,
    val relationships: Map<String, Relationship>,
    val preferences: Preferences,
    val development: CharacterDevelopment
)

data class CharacterMemory(
    val content: String,
    val category: MemoryCategory,
    val emotionalWeight: Float,
    val importance: Float,
    val timestamp: Long
)
```

### WorldBook (世界知识)

**文件位置**: `domain/knowledge/WorldBook.kt`

**核心数据结构**:
```kotlin
data class WorldKnowledge(
    val facts: List<WorldFact>,
    val concepts: List<Concept>,
    val rules: List<WorldRule>,
    val contexts: List<Context>
)

data class WorldFact(
    val subject: String,
    val predicate: String,
    val object: String,
    val confidence: Float,
    val source: KnowledgeSource
)
```

## 社交系统 (Social System)

社交系统负责管理人物关系和社交互动，支持第三方关系提取。

### 社交关系管理

**文件位置**: `domain/social/SocialSystem.kt`

**核心功能**:
- 关系图谱构建和维护
- 社交影响评估
- 第三方关系提取
- 关系强度计算

**关系维度**:
```kotlin
data class Relationship(
    val intimacy: Float,      // 亲密度
    val trust: Float,         // 信任度
    val affection: Float,     // 好感度
    val history: List<Interaction> // 互动历史
)
```

### 第三方关系提取

**核心算法**:
```kotlin
suspend fun extractThirdPartyRelations(
    conversation: String,
    knownPeople: Set<String>
): List<ThirdPartyRelation> {
    // 1. 实体识别
    val entities = extractEntities(conversation)

    // 2. 关系提取
    val relations = extractRelations(conversation, entities)

    // 3. 关系类型分类
    return classifyRelations(relations, knownPeople)
}
```

## 数据流架构

### 心流循环数据流

```
感知层 → 思考层 → 决策层 → 行动层
   ↓        ↓        ↓        ↓
环境信息 → 内心想法 → 发言决策 → 实际行动
   ↓        ↓        ↓        ↓
记忆系统 ← 知识系统 ← 社交系统 ← 对话系统
```

### 记忆处理数据流

```
新记忆输入
    ↓
语义分析
    ↓
冲突检测 → 有冲突 → 记忆重构
    ↓           ↓
无冲突        重构结果
    ↓           ↓
存储记忆 ← 更新记忆
    ↓
知识整合
```

## 设计模式应用

### 1. 分层架构 (Layered Architecture)
- **表现层**: UI组件和界面逻辑
- **领域层**: 业务逻辑和核心算法
- **数据层**: 数据存储和外部服务

### 2. 依赖注入 (Dependency Injection)
- 使用Hilt框架管理依赖
- 支持测试和模块替换

### 3. 观察者模式 (Observer Pattern)
- 心流系统观察环境变化
- 记忆系统观察知识更新

### 4. 策略模式 (Strategy Pattern)
- 记忆重构策略选择
- 社交关系评估策略

## 性能优化

### 1. 异步处理
- 所有耗时操作使用协程
- 并行处理独立任务

### 2. 缓存机制
- 记忆查询结果缓存
- 社交关系缓存
- 环境状态缓存

### 3. 懒加载
- 知识系统按需加载
- 记忆系统分页查询

### 4. 资源管理
- 数据库连接池
- 网络请求限流
- 内存使用监控

## 扩展性设计

### 1. 插件化架构
- 工具调用系统支持插件
- 记忆存储支持多种后端
- 社交算法可替换

### 2. 配置驱动
- 心流参数可配置
- 记忆策略可调整
- 社交阈值可设置

### 3. 接口标准化
- 统一的API接口
- 标准的数据模型
- 一致的错误处理

## UI系统 (Presentation Layer) ⭐新增

UI系统是用户与小光交互的窗口，采用**情绪驱动设计**理念，将小光的内在情绪通过视觉元素实时传达给用户。

### 1. 设计系统 (Design System)

**文件位置**: `presentation/design/XiaoguangDesignSystem.kt`

**核心规范**:
- **情绪色彩系统**: 6种情绪 × 4个色阶 = 24个主题颜色
- **动画时长规范**: 从150ms到2000ms的标准化动画时长
- **间距系统**: 基于8dp网格的9级间距体系
- **Typography**: Material3标准字体体系

**情绪色彩映射**:
```kotlin
EmotionType.HAPPY    → 温暖橙黄色 (#FFB84D)
EmotionType.CALM     → 柔和蓝紫色 (#9FA8DA)
EmotionType.CURIOUS  → 智慧青绿色 (#4DB6AC)
EmotionType.SURPRISED→ 活泼粉紫色 (#BA68C8)
EmotionType.SAD      → 柔和灰蓝色 (#90A4AE)
EmotionType.EMBARRASSED → 温和玫瑰粉 (#F06292)
```

### 2. 主题系统 (Theme System)

**文件位置**: `presentation/design/XiaoguangTheme.kt`

**核心功能**:
- **明暗双主题**: 自动适配系统暗色模式
- **情绪自适应**: 根据当前情绪动态调整主题颜色
- **Material3集成**: 完整的Material Design 3支持

**主题切换流程**:
```kotlin
XiaoguangTheme(
    darkTheme = isSystemInDarkTheme(),
    emotion = coreState.emotion.currentEmotion
) {
    // 自动应用情绪主题颜色
}
```

### 3. 动画系统 (Animation System)

**文件位置**: `presentation/design/XiaoguangAnimations.kt`

**核心动画**:

**页面转场**:
- `fadeInOut()` - 淡入淡出 + 缩放（底部Tab）
- `slideInFromRight()` - 从右侧滑入（对话、开发者页）
- `slideInFromBottom()` - 从底部滑入（抽屉菜单页）
- `expandVertically()` - 垂直展开（内容展开）

**交互动画**:
- `clickableScale` - 点击缩放反馈（0.95倍缩放）
- `pulse` - 脉冲效果（用于头像、按钮）
- `breathing` - 呼吸透明度（0.6 ~ 1.0）
- `animateEnter` - 错落进入动画（淡入 + 上移）

**循环动画**:
- `rememberPulseAnimation()` - 无限脉冲（1.0 ~ 1.05）
- `rememberBreathingAnimation()` - 呼吸效果
- `rememberWaveAnimation()` - 波动旋转（0° ~ 360°）
- `rememberShakeAnimation()` - 震动提示

### 4. 组件库 (Component Library)

**原子组件**:
- **XiaoguangAvatar** - 6种表情的卡通头像，支持呼吸和脉冲动画
- **EmotionIndicator** - 情绪名称 + 图标显示
- **FlowImpulseIndicator** - 心流冲动强度进度条
- **SpeakerIndicator** - 说话人识别状态

**分子组件**:
- **PersonCard** - 人物信息卡片（头像 + 信息 + 亲密度）
- **MemoryCard** - 记忆条目卡片（分类 + 内容 + 时间）
- **ConversationMessageCard** - 对话消息卡片（角色 + 内容 + 情绪标签）
- **XiaoguangButtons** - 5种按钮样式（Primary、Secondary、Text、Icon、FAB）

### 5. 页面架构 (Screen Architecture)

**导航结构**:
```
XiaoguangNavHost (主导航容器)
├── 底部导航栏 (5个Tab)
│   ├── 小光中心 (XiaoguangCenterScreen)
│   ├── 对话 (NewConversationScreen)
│   ├── 人物 (PeopleScreen)
│   ├── 日程 (ScheduleScreen)
│   └── 我的 (ProfileScreen)
├── 抽屉菜单 (6个页面)
│   ├── 记忆浏览 (MemoryBrowserScreen)
│   ├── 知识中心 (KnowledgeHubScreen)
│   ├── 心流状态 (FlowStatusScreen)
│   ├── 待办事项 (TodoListScreen) [待实现]
│   ├── 环境监听 (EnvironmentMonitorScreen) [待实现]
│   └── 开发者选项 (DeveloperOptionsScreen)
└── 详情页面 (多个)
    ├── 人物详情 (PersonDetailScreen) [待实现]
    ├── 记忆详情 (MemoryDetailScreen) [待实现]
    └── ...
```

**小光中心页面**:
- 大头像展示（XXL尺寸，128dp）
- 情绪描述卡片
- 当前想法气泡（浮动动画）
- 心流冲动指示器
- 说话人识别状态
- 快捷操作按钮
- **特色**: 错落进入动画（0ms → 100ms → 200ms → ...）

### 6. 状态管理 (State Management)

**统一状态容器**:
```kotlin
// XiaoguangCoreState.kt
data class XiaoguangCoreState(
    val emotion: EmotionState,           // 当前情绪
    val flow: FlowState,                 // 心流状态
    val speaker: SpeakerState,           // 说话人状态
    val environment: EnvironmentState,   // 环境状态
    val conversation: ConversationState, // 对话状态
    val system: SystemState              // 系统状态
)
```

**状态传播流程**:
```
心流系统更新情绪
    ↓
XiaoguangCoreStateManager发布新状态
    ↓
ViewModel通过StateFlow订阅
    ↓
Composable通过collectAsState()获取
    ↓
UI自动更新（情绪颜色、动画等）
```

### 7. UI特色设计

**情绪驱动视觉**:
- UI颜色实时跟随小光情绪变化
- 头像表情随情绪自动切换
- 情绪卡片显示情绪原因和强度

**温暖人性化**:
- 358条精心设计的温暖文案
- 友好的问候语和提示信息
- 贴心的交互反馈

**流畅动画体验**:
- 页面切换流畅自然（300ms标准转场）
- 错落进入效果增强层次感
- 点击反馈提供触觉确认
- 循环动画增添生命力

**响应式设计**:
- 支持不同屏幕尺寸
- 自适应横竖屏
- 优雅降级策略

### 8. UI性能优化

**重组优化**:
- 使用 `remember` 缓存计算
- 使用 `derivedStateOf` 派生状态
- 稳定的 `key` 提升列表性能

**动画优化**:
- 合理控制动画时长
- 避免过度使用循环动画
- 使用硬件加速

**资源优化**:
- 懒加载长列表内容
- 图片资源适配
- 避免过度绘制

### 9. UI开发规范

**组件设计原则**:
1. 所有组件必须支持 `modifier` 参数
2. 使用 `LocalEmotionColors.current` 获取主题颜色
3. 优先使用设计系统定义的规范值
4. 提供清晰的 `@Preview` 预览

**状态管理原则**:
1. ViewModel使用 `@HiltViewModel` 注入
2. 状态使用 `StateFlow` 发布
3. UI使用 `collectAsState()` 订阅
4. 避免在Composable中直接修改状态

**动画使用原则**:
1. 页面转场使用 `XiaoguangAnimations.Transitions`
2. 交互反馈使用 `clickableScale`
3. 循环动画使用 `remember*Animation()`
4. 进入动画使用 `animateEnter(delayMillis)`

详细UI设计文档请参考: [UI架构设计.md](./UI架构设计.md)

---

*文档最后更新: 2025-11-17*

这个架构设计确保了系统的高内聚、低耦合，同时提供了良好的扩展性和维护性。