# 小光AI助手 - 服务器部署指南 (Windows)

## 概述

本文档详细说明如何在 Windows 服务器上部署小光AI助手的后端数据库服务，包括 ChromaDB（向量数据库）和 Neo4j（图数据库）。

> **⚠️ 重要提示**: ChromaDB 在 Linux 上运行更稳定，性能更好。Windows 上的 ChromaDB 1.3.4 存在已知稳定性问题（ADD 端点可能崩溃）。**强烈推荐使用 Linux 部署**，详见 [Linux服务器部署指南.md](./Linux服务器部署指南.md)。
>
> 如果必须使用 Windows，请考虑：
> - 降级到 ChromaDB 0.5.x 稳定版本
> - 或使用 WSL2 (Windows Subsystem for Linux) 运行 Linux 环境

## 服务器要求

### 硬件要求
- **CPU**: 2核心或以上
- **内存**: 4GB 或以上（推荐 8GB）
- **存储**: 20GB 可用空间

### 软件要求
- **操作系统**: Windows Server 2016/2019/2022 或 Windows 10/11
- **Python**: 3.10 或更高版本
- **Java**: 17 或更高版本（推荐使用 OpenJDK）

### 网络要求
- **端口开放**:
  - `8000`: ChromaDB HTTP API
  - `7474`: Neo4j HTTP/Browser 接口
  - `7687`: Neo4j Bolt 协议

## 部署脚本说明

### 文件结构

```
server-native/
├── 1-install.bat              # 主安装脚本
├── 1-install-server.bat       # 服务器专用安装脚本（硬编码路径）
├── 2-start-services.bat       # 服务管理菜单
├── start-chromadb.bat         # 启动 ChromaDB
├── start-neo4j.bat            # 启动 Neo4j
├── SIMPLE_SETUP.bat           # ChromaDB 独立安装
├── README.txt                 # 快速参考
├── QUICK_START.txt            # 快速启动指南
└── data/                      # 数据存储目录（自动创建）
    ├── chromadb/             # ChromaDB 数据
    └── neo4j/                # Neo4j 数据
```

### 核心脚本功能

#### 1-install.bat
**功能**: 自动安装和配置 ChromaDB 和 Neo4j

**执行流程**:
1. 检查 Python 和 Java 环境
2. 使用中国镜像源安装 ChromaDB
3. 检测或下载 Neo4j
4. 解压并配置 Neo4j
5. 设置初始密码为 `xiaoguang123`
6. 创建数据目录

**使用方法**:
```bash
cd server-native
1-install.bat
```

#### 2-start-services.bat
**功能**: 服务管理菜单

**功能选项**:
1. 启动所有服务
2. 仅启动 ChromaDB
3. 仅启动 Neo4j
4. 显示连接信息
5. 生成配置文件

**使用方法**:
```bash
2-start-services.bat
# 然后根据菜单选择操作
```

## 安装步骤

### 步骤 1: 准备环境

#### 安装 Python

1. 下载 Python 3.10+: https://www.python.org/downloads/
2. 运行安装程序，**务必勾选** "Add Python to PATH"
3. 验证安装:
   ```bash
   python --version
   ```

#### 安装 Java

1. 下载 OpenJDK 17+: https://adoptium.net/
2. 运行安装程序
3. 验证安装:
   ```bash
   java -version
   ```

### 步骤 2: 准备 Neo4j 安装包（可选）

如果网络较慢或下载失败，可以手动下载 Neo4j：

1. 下载地址（选择其一）:
   - 阿里云镜像: https://mirrors.aliyun.com/neo4j/neo4j-community-5.14.0-windows.zip
   - 官方网站: https://neo4j.com/download/

2. 将下载的文件重命名为 `neo4j.zip`

3. 放置到 `server-native` 目录

### 步骤 3: 运行安装脚本

1. 打开命令提示符（管理员权限）
2. 进入部署目录:
   ```bash
   cd C:\path\to\server-native
   ```
3. 运行安装脚本:
   ```bash
   1-install.bat
   ```
4. 等待安装完成

**注意事项**:
- ChromaDB 安装可能需要 5-10 分钟（取决于网络）
- Neo4j 解压可能需要 1-2 分钟
- 出现警告信息是正常的，不影响功能

### 步骤 4: 启动服务

安装完成后:

```bash
2-start-services.bat
```

选择 `1` 启动所有服务。

**首次启动时间**:
- ChromaDB: 约 5-10 秒
- Neo4j: 约 30-60 秒（首次启动较慢）

## 配置说明

### 默认配置

| 服务 | 端口 | 用户名 | 密码 | 数据库 |
|------|------|--------|------|--------|
| ChromaDB | 8000 | - | - | - |
| Neo4j HTTP | 7474 | neo4j | xiaoguang123 | neo4j |
| Neo4j Bolt | 7687 | neo4j | xiaoguang123 | neo4j |

### 修改配置

#### 修改 Neo4j 密码

```bash
cd server-native\neo4j\bin
neo4j-admin.bat set-initial-password NEW_PASSWORD
```

**重要**: 修改密码后需要同步更新 Android 应用的 `local.properties`:
```properties
NEO4J_PASSWORD=NEW_PASSWORD
```

#### 修改端口

**ChromaDB 端口**:
编辑 `start-chromadb.bat`:
```batch
chroma run --port 9000
```

**Neo4j 端口**:
编辑 `neo4j\conf\neo4j.conf`:
```properties
server.bolt.listen_address=:7688
server.http.listen_address=:7475
```

## 服务管理

### 查看服务状态

**ChromaDB**:
- 访问: http://localhost:8000
- 健康检查: http://localhost:8000/api/v1/heartbeat

**Neo4j**:
- 访问: http://localhost:7474
- 浏览器界面可以查看数据库状态和执行查询

### 停止服务

按 `Ctrl + C` 停止正在运行的服务窗口。

### 重启服务

```bash
# 停止后重新运行
2-start-services.bat
```

### 数据备份

#### 备份 ChromaDB

```bash
# 复制整个数据目录
xcopy /E /I server-native\data\chromadb backup\chromadb
```

#### 备份 Neo4j

使用 Neo4j 内置工具:
```bash
cd server-native\neo4j\bin
neo4j-admin.bat dump --database=neo4j --to=backup\neo4j-backup.dump
```

恢复备份:
```bash
neo4j-admin.bat load --from=backup\neo4j-backup.dump --database=neo4j --force
```

## 防火墙配置

### Windows 防火墙规则

```powershell
# 允许 ChromaDB 端口
netsh advfirewall firewall add rule name="ChromaDB" dir=in action=allow protocol=TCP localport=8000

# 允许 Neo4j HTTP 端口
netsh advfirewall firewall add rule name="Neo4j HTTP" dir=in action=allow protocol=TCP localport=7474

# 允许 Neo4j Bolt 端口
netsh advfirewall firewall add rule name="Neo4j Bolt" dir=in action=allow protocol=TCP localport=7687
```

### 云服务器安全组

如果使用云服务器（阿里云、腾讯云等），需要在安全组中开放端口：
- 入站规则：TCP 7474、7687、8000

## 故障排除

### ChromaDB 无法启动

**问题**: `ModuleNotFoundError: No module named 'chromadb'`

**解决方案**:
```bash
pip install chromadb -i https://pypi.tuna.tsinghua.edu.cn/simple
```

**问题**: 端口 8000 被占用

**解决方案**:
```bash
# 查找占用进程
netstat -ano | findstr :8000

# 结束进程
taskkill /PID <进程ID> /F
```

### Neo4j 无法启动

**问题**: Java 版本过低

**解决方案**:
- 确保安装 Java 17 或更高版本
- 设置 JAVA_HOME 环境变量

**问题**: 内存不足

**解决方案**:
编辑 `neo4j\conf\neo4j.conf`:
```properties
server.memory.heap.initial_size=512m
server.memory.heap.max_size=1g
```

**问题**: 端口被占用

**解决方案**:
```bash
# 查找占用进程
netstat -ano | findstr :7474
netstat -ano | findstr :7687

# 结束进程或修改配置文件使用其他端口
```

### 网络连接问题

**问题**: Android 应用无法连接数据库

**检查清单**:
1. ✅ 服务器防火墙已开放端口
2. ✅ 云安全组已配置
3. ✅ 服务正在运行（查看服务窗口）
4. ✅ IP 地址配置正确
5. ✅ Android 设备与服务器网络互通

**测试连接**:
```bash
# 在 Android 设备上使用浏览器访问
http://SERVER_IP:8000
http://SERVER_IP:7474
```

## 性能优化

### ChromaDB 优化

**调整批处理大小**:
在应用代码中配置：
```kotlin
val batchSize = 100  // 根据服务器性能调整
```

**启用持久化**:
ChromaDB 默认启用持久化，数据自动保存到 `data/chromadb`。

### Neo4j 优化

**调整内存配置**:
编辑 `neo4j\conf\neo4j.conf`:
```properties
# 页面缓存（越大越好，推荐物理内存的 50%）
server.memory.pagecache.size=2g

# 堆内存（推荐 1-4g）
server.memory.heap.initial_size=1g
server.memory.heap.max_size=2g
```

**启用查询日志**:
```properties
dbms.logs.query.enabled=true
dbms.logs.query.threshold=1s
```

## 监控和维护

### 日志位置

**ChromaDB 日志**:
- 控制台输出（启动窗口）
- 配置文件日志: `data/chromadb/chroma.log`

**Neo4j 日志**:
- `neo4j/logs/neo4j.log`: 主日志
- `neo4j/logs/debug.log`: 调试日志
- `neo4j/logs/query.log`: 查询日志

### 定期维护

**每周任务**:
- 检查日志文件大小，必要时清理
- 查看服务运行状态

**每月任务**:
- 备份数据库
- 检查存储空间
- 更新系统补丁

**每季度任务**:
- 审查性能指标
- 优化数据库配置
- 测试恢复流程

## 升级指南

### 升级 ChromaDB

```bash
pip install --upgrade chromadb
```

重启服务生效。

### 升级 Neo4j

1. 备份数据
2. 下载新版本 Neo4j
3. 停止旧版本服务
4. 解压新版本到相同位置
5. 复制 `conf/neo4j.conf` 配置文件
6. 启动新版本
7. 验证数据完整性

## 附录

### 常用命令

```bash
# 查看 Python 包
pip list

# 查看进程
tasklist | findstr python
tasklist | findstr java

# 查看端口占用
netstat -ano | findstr :8000
netstat -ano | findstr :7474
netstat -ano | findstr :7687

# 系统信息
systeminfo
```

### 相关链接

- **ChromaDB 官方文档**: https://docs.trychroma.com/
- **Neo4j 官方文档**: https://neo4j.com/docs/
- **Python 下载**: https://www.python.org/downloads/
- **Java 下载**: https://adoptium.net/
- **Neo4j 中国镜像**: https://mirrors.aliyun.com/neo4j/

### 技术支持

遇到问题时，请提供以下信息：
1. 操作系统版本
2. Python 版本 (`python --version`)
3. Java 版本 (`java -version`)
4. 错误日志内容
5. 服务器配置信息

---

**文档版本**: v1.1
**最后更新**: 2025-11-18
**更新内容**: 添加 ChromaDB 稳定性警告和 Linux 部署指南链接
