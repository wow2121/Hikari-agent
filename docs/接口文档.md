# 小光AI助手 - 接口文档

## 概述

本文档详细描述了小光AI助手系统的所有主要接口，包括记忆系统、心流系统、社交系统等核心模块的API定义。

## 记忆系统接口

### 统一记忆系统 (UnifiedMemorySystem)

**文件位置**: `domain/memory/UnifiedMemorySystem.kt`

#### 1. 记忆查询接口

```kotlin
/**
 * 多维度记忆查询
 * @param query 记忆查询条件
 * @return 排序后的记忆列表
 */
suspend fun queryMemories(query: MemoryQuery): List<RankedMemory>

/**
 * 记忆查询参数
 */
data class MemoryQuery(
    // 语义查询
    val semantic: String? = null,

    // 实体查询
    val entities: List<String>? = null,

    // 时间查询
    val temporal: TemporalQuery? = null,

    // 情感查询
    val emotion: EmotionQuery? = null,

    // 分类查询
    val category: MemoryCategory? = null,

    // 分页参数
    val limit: Int = 50,
    val offset: Int = 0
)

/**
 * 时间查询条件
 */
data class TemporalQuery(
    val startTime: Long? = null,
    val endTime: Long? = null,
    val timeRange: TimeRange? = null
)

/**
 * 情感查询条件
 */
data class EmotionQuery(
    val emotionType: EmotionType? = null,
    val intensityRange: ClosedRange<Float>? = null
)
```

#### 2. 记忆存储接口

```kotlin
/**
 * 存储新记忆
 * @param memory 记忆数据
 * @return 存储结果
 */
suspend fun storeMemory(memory: Memory): MemoryResult

/**
 * 记忆数据结构
 */
data class Memory(
    val id: String,
    val content: String,
    val category: MemoryCategory,
    val metadata: MemoryMetadata,
    val entities: List<Entity>,
    val emotions: List<Emotion>,
    val timestamp: Long
)

/**
 * 记忆元数据
 */
data class MemoryMetadata(
    val source: MemorySource,
    val confidence: Float,
    val importance: Float,
    val accessibility: Float
)

/**
 * 存储结果
 */
data class MemoryResult(
    val success: Boolean,
    val memoryId: String?,
    val conflicts: List<MemoryConflict>?,
    val reconstruction: ReconstructionResult?
)
```

#### 3. 记忆更新接口

```kotlin
/**
 * 更新现有记忆
 * @param memoryId 记忆ID
 * @param updates 更新内容
 * @return 更新结果
 */
suspend fun updateMemory(memoryId: String, updates: MemoryUpdate): MemoryResult

/**
 * 记忆更新参数
 */
data class MemoryUpdate(
    val content: String? = null,
    val metadata: MemoryMetadata? = null,
    val entities: List<Entity>? = null,
    val emotions: List<Emotion>? = null,
    val updateType: UpdateType
)
```

#### 4. 记忆删除接口

```kotlin
/**
 * 删除记忆
 * @param memoryId 记忆ID
 * @return 删除是否成功
 */
suspend fun deleteMemory(memoryId: String): Boolean
```

### 记忆重构服务 (MemoryReconstructionService)

**文件位置**: `domain/memory/reconstruction/MemoryReconstructionService.kt`

```kotlin
/**
 * 记忆重构接口
 * @param conflicts 记忆冲突列表
 * @return 重构结果
 */
suspend fun reconstruct(conflicts: List<MemoryConflict>): ReconstructionResult

/**
 * 记忆冲突
 */
data class MemoryConflict(
    val existingMemory: Memory,
    val newMemory: Memory,
    val conflictType: ConflictType,
    val severity: Float
)

/**
 * 重构结果
 */
data class ReconstructionResult(
    val success: Boolean,
    val updatedMemories: List<Memory>,
    val newMemories: List<Memory>,
    val deletedMemories: List<String>,
    val reconstructionType: ReconstructionType
)
```

## 心流系统接口

### 感知层 (PerceptionLayer)

**文件位置**: `domain/flow/layer/PerceptionLayer.kt`

```kotlin
/**
 * 环境感知接口
 * @return 感知结果
 */
suspend fun perceive(): Perception

/**
 * 感知结果
 */
data class Perception(
    // 环境上下文
    val environment: EnvironmentContext,

    // 对话内容
    val conversation: ConversationSegment?,

    // 社交关系
    val social: SocialRelations,

    // 用户情绪
    val emotion: UserEmotion,

    // 时间上下文
    val temporal: TemporalContext
)

/**
 * 环境上下文
 */
data class EnvironmentContext(
    val location: Location?,
    val timeOfDay: TimeOfDay,
    val weather: Weather?,
    val noiseLevel: NoiseLevel,
    val peoplePresent: List<Person>
)

/**
 * 对话片段
 */
data class ConversationSegment(
    val speaker: String,
    val content: String,
    val timestamp: Long,
    val emotion: EmotionType?
)
```

### 思考层 (ThinkingLayer)

**文件位置**: `domain/flow/layer/ThinkingLayer.kt`

```kotlin
/**
 * 思考生成接口
 * @param perception 感知结果
 * @return 内心想法列表
 */
suspend fun think(perception: Perception): List<InnerThought>

/**
 * 内心想法
 */
data class InnerThought(
    val content: String,
    val type: ThoughtType,
    val confidence: Float,
    val emotionalTone: EmotionalTone,
    val triggers: List<ThoughtTrigger>
)

/**
 * 想法类型
 */
enum class ThoughtType {
    OBSERVATION,      // 观察
    REFLECTION,       // 反思
    CURIOSITY,        // 好奇心
    CONCERN,          // 关心
    REMINDER,         // 提醒
    SUGGESTION        // 建议
}
```

### 决策层 (DecisionLayer)

**文件位置**: `domain/flow/layer/DecisionLayer.kt`

```kotlin
/**
 * 发言决策接口
 * @param perception 感知结果
 * @param thoughts 内心想法
 * @return 发言决策
 */
suspend fun decide(
    perception: Perception,
    thoughts: List<InnerThought>
): SpeakDecision

/**
 * 发言决策
 */
data class SpeakDecision(
    val shouldSpeak: Boolean,
    val content: String?,
    val tone: ToneType,
    val confidence: Float,
    val timing: SpeakingTiming,
    val targetPerson: String?
)

/**
 * 发言时机
 */
enum class SpeakingTiming {
    IMMEDIATE,        // 立即
    AFTER_PAUSE,      // 停顿后
    LATER,            // 稍后
    OPPORTUNISTIC     // 机会主义
}
```

### 行动层 (ActionLayer)

**文件位置**: `domain/flow/layer/ActionLayer.kt`

```kotlin
/**
 * 行动执行接口
 * @param decision 发言决策
 */
suspend fun act(decision: SpeakDecision)

/**
 * 工具调用接口
 * @param toolCall 工具调用请求
 * @return 工具调用结果
 */
suspend fun callTool(toolCall: ToolCall): ToolResult

/**
 * 工具调用请求
 */
data class ToolCall(
    val toolName: String,
    val parameters: Map<String, Any>,
    val context: ToolContext
)

/**
 * 工具调用结果
 */
data class ToolResult(
    val success: Boolean,
    val result: Any?,
    val error: String?,
    val executionTime: Long
)
```

## 社交系统接口

### 社交系统 (SocialSystem)

**文件位置**: `domain/social/SocialSystem.kt`

#### 1. 社交关系查询接口

```kotlin
/**
 * 查询人物关系
 * @param personName 人物名称
 * @return 关系信息
 */
suspend fun getRelationship(personName: String): Relationship?

/**
 * 查询所有关系
 * @return 关系映射
 */
suspend fun getAllRelationships(): Map<String, Relationship>

/**
 * 关系数据结构
 */
data class Relationship(
    val intimacy: Float,              // 亲密度 (0.0-1.0)
    val trust: Float,                 // 信任度 (0.0-1.0)
    val affection: Float,             // 好感度 (0.0-1.0)
    val history: List<Interaction>,   // 互动历史
    val lastUpdated: Long             // 最后更新时间
)
```

#### 2. 社交关系更新接口

```kotlin
/**
 * 更新社交关系
 * @param interaction 互动信息
 * @return 更新结果
 */
suspend fun updateRelationship(interaction: Interaction): UpdateResult

/**
 * 互动信息
 */
data class Interaction(
    val person: String,
    val type: InteractionType,
    val content: String?,
    val emotion: EmotionType?,
    val timestamp: Long,
    val duration: Long?
)

/**
 * 更新结果
 */
data class UpdateResult(
    val success: Boolean,
    val relationshipChanges: Map<String, Float>,
    val newRelationships: List<String>
)
```

#### 3. 第三方关系提取接口

```kotlin
/**
 * 提取第三方关系
 * @param conversation 对话内容
 * @param knownPeople 已知人物
 * @return 提取的关系列表
 */
suspend fun extractThirdPartyRelations(
    conversation: String,
    knownPeople: Set<String>
): List<ThirdPartyRelation>

/**
 * 第三方关系
 */
data class ThirdPartyRelation(
    val personA: String,
    val personB: String,
    val relationType: RelationType,
    val confidence: Float,
    val source: String
)
```

#### 4. 社交影响评估接口

```kotlin
/**
 * 评估环境社交影响
 * @param conversation 对话片段
 * @param knownPeople 已知人物
 * @return 社交影响列表
 */
suspend fun evaluateEnvironmentSocialImpact(
    conversationSegment: String,
    knownPeople: Map<String, Float>
): List<EnvironmentSocialImpact>

/**
 * 环境社交影响
 */
data class EnvironmentSocialImpact(
    val person: String,
    val impactType: SocialImpactType,
    val intensity: Float,
    val reason: String
)
```

## 知识系统接口

### CharacterBook (角色档案)

**文件位置**: `domain/knowledge/CharacterBook.kt`

```kotlin
/**
 * 查询角色档案
 * @param personName 人物名称
 * @return 角色档案
 */
suspend fun getCharacterProfile(personName: String): CharacterProfile?

/**
 * 更新角色档案
 * @param profile 角色档案
 * @return 更新结果
 */
suspend fun updateCharacterProfile(profile: CharacterProfile): Boolean

/**
 * 添加角色记忆
 * @param personName 人物名称
 * @param memory 记忆内容
 * @return 添加结果
 */
suspend fun addCharacterMemory(personName: String, memory: CharacterMemory): Boolean

/**
 * 角色档案
 */
data class CharacterProfile(
    val name: String,
    val traits: List<PersonalityTrait>,
    val memories: List<CharacterMemory>,
    val relationships: Map<String, Relationship>,
    val preferences: Preferences,
    val development: CharacterDevelopment
)
```

### WorldBook (世界知识)

**文件位置**: `domain/knowledge/WorldBook.kt`

```kotlin
/**
 * 查询世界知识
 * @param query 查询条件
 * @return 相关知识
 */
suspend fun queryWorldKnowledge(query: WorldQuery): List<WorldFact>

/**
 * 添加世界知识
 * @param fact 世界事实
 * @return 添加结果
 */
suspend fun addWorldFact(fact: WorldFact): Boolean

/**
 * 世界查询条件
 */
data class WorldQuery(
    val subject: String? = null,
    val predicate: String? = null,
    val object: String? = null,
    val concept: String? = null
)
```

## 日程系统接口

### 日程管理 (ScheduleSystem)

**文件位置**: `domain/schedule/ScheduleSystem.kt`

```kotlin
/**
 * 添加日程
 * @param schedule 日程信息
 * @return 添加结果
 */
suspend fun addSchedule(schedule: Schedule): Boolean

/**
 * 查询日程
 * @param startTime 开始时间
 * @param endTime 结束时间
 * @return 日程列表
 */
suspend fun getSchedules(startTime: Long, endTime: Long): List<Schedule>

/**
 * 更新日程
 * @param scheduleId 日程ID
 * @param updates 更新内容
 * @return 更新结果
 */
suspend fun updateSchedule(scheduleId: String, updates: ScheduleUpdate): Boolean

/**
 * 删除日程
 * @param scheduleId 日程ID
 * @return 删除结果
 */
suspend fun deleteSchedule(scheduleId: String): Boolean

/**
 * 日程信息
 */
data class Schedule(
    val id: String,
    val title: String,
    val description: String?,
    val startTime: Long,
    val endTime: Long,
    val priority: Priority,
    val category: ScheduleCategory,
    val reminder: Reminder?
)
```

## 工具调用接口

### MCP工具系统

**文件位置**: `domain/tools/McpToolSystem.kt`

```kotlin
/**
 * 注册工具
 * @param tool 工具定义
 * @return 注册结果
 */
suspend fun registerTool(tool: ToolDefinition): Boolean

/**
 * 执行工具调用
 * @param request 工具调用请求
 * @return 调用结果
 */
suspend fun executeTool(request: ToolExecutionRequest): ToolExecutionResult

/**
 * 获取可用工具
 * @return 工具列表
 */
suspend fun getAvailableTools(): List<ToolDefinition>

/**
 * 工具定义
 */
data class ToolDefinition(
    val name: String,
    val description: String,
    val parameters: List<ToolParameter>,
    val returnType: ToolReturnType
)

/**
 * 工具执行请求
 */
data class ToolExecutionRequest(
    val toolName: String,
    val parameters: Map<String, Any>,
    val context: ExecutionContext
)
```

## 错误处理

### 统一错误类型

```kotlin
/**
 * 系统错误类型
 */
sealed class SystemError {
    data class MemoryError(val reason: String) : SystemError()
    data class FlowError(val reason: String) : SystemError()
    data class SocialError(val reason: String) : SystemError()
    data class KnowledgeError(val reason: String) : SystemError()
    data class ToolError(val reason: String) : SystemError()
    data class NetworkError(val reason: String) : SystemError()
}

/**
 * 统一响应格式
 */
data class ApiResponse<T>(
    val success: Boolean,
    val data: T?,
    val error: SystemError?,
    val timestamp: Long
)
```

## 使用示例

### 记忆查询示例

```kotlin
// 查询与"工作"相关的记忆
val query = MemoryQuery(
    semantic = "工作",
    category = MemoryCategory.WORK,
    limit = 10
)

val memories = memorySystem.queryMemories(query)
```

### 社交关系更新示例

```kotlin
// 记录一次积极互动
val interaction = Interaction(
    person = "小明",
    type = InteractionType.POSITIVE_CONVERSATION,
    content = "今天聊得很开心",
    emotion = EmotionType.HAPPY,
    timestamp = System.currentTimeMillis()
)

val result = socialSystem.updateRelationship(interaction)
```

### 工具调用示例

```kotlin
// 调用天气查询工具
val request = ToolExecutionRequest(
    toolName = "weather_query",
    parameters = mapOf("city" to "北京"),
    context = currentContext
)

val result = toolSystem.executeTool(request)
```

### 声纹识别示例

```kotlin
// 注册新声纹
val request = VoiceprintRegistrationRequest(
    audioSamples = listOf(audioData1, audioData2, audioData3),
    sampleRate = 16000,
    personName = "张三",
    isMaster = false
)

val result = voiceprintManager.registerVoiceprint(request)

// 识别说话人
val identityResult = voiceprintManager.identifySpeaker(
    audioData = currentAudioData,
    sampleRate = 16000
)

if (identityResult.matched) {
    println("识别到: ${identityResult.profile?.personName}")
}
```

## 声纹识别系统接口

### VoiceprintManager (声纹管理器)

**文件位置**: `domain/voiceprint/VoiceprintManager.kt`

#### 1. 声纹注册接口

```kotlin
/**
 * 注册新声纹
 * @param request 注册请求（包含音频样本和人物信息）
 * @return 注册成功的声纹档案
 */
suspend fun registerVoiceprint(
    request: VoiceprintRegistrationRequest
): Result<VoiceprintProfile>

/**
 * 声纹注册请求
 */
data class VoiceprintRegistrationRequest(
    // 音频样本（至少3个）
    val audioSamples: List<ByteArray>,

    // 采样率
    val sampleRate: Int = 16000,

    // 人物信息
    val personId: String? = null,
    val personName: String? = null,
    val isMaster: Boolean = false,

    // 附加元数据
    val metadata: Map<String, String> = emptyMap()
)

/**
 * 声纹档案
 */
data class VoiceprintProfile(
    val voiceprintId: String,
    val personId: String,
    val personName: String?,
    val displayName: String,
    val isMaster: Boolean,
    val isStranger: Boolean,
    val featureVector: FloatArray,
    val sampleCount: Int,
    val confidence: Float,
    val createdAt: Long = System.currentTimeMillis(),
    val updatedAt: Long = System.currentTimeMillis(),
    val metadata: Map<String, String> = emptyMap()
)
```

#### 2. 声纹识别接口

```kotlin
/**
 * 识别说话人
 * @param audioData PCM音频数据
 * @param sampleRate 采样率
 * @return 识别结果
 */
suspend fun identifySpeaker(
    audioData: ByteArray,
    sampleRate: Int = 16000
): Result<VoiceprintIdentificationResult>

/**
 * 声纹识别结果
 */
data class VoiceprintIdentificationResult(
    val matched: Boolean,
    val profile: VoiceprintProfile?,
    val similarity: Float,
    val confidence: Float,
    val speakerId: String
)
```

#### 3. 声纹管理接口

```kotlin
/**
 * 获取主人声纹档案
 */
suspend fun getMasterProfile(): VoiceprintProfile?

/**
 * 更新声纹名称（陌生人被识别后）
 */
suspend fun updatePersonName(
    voiceprintId: String,
    newName: String
): Result<Unit>

/**
 * 删除声纹档案
 */
suspend fun deleteVoiceprint(voiceprintId: String): Result<Unit>

/**
 * 获取所有声纹档案
 */
suspend fun getAllProfiles(): List<VoiceprintProfile>
```

### NameInferenceService (名称推断服务)

**文件位置**: `domain/voiceprint/NameInferenceService.kt`

```kotlin
/**
 * 从对话中推断陌生人的名称
 * @param strangerId 陌生人ID
 * @param recentMessages 最近的对话
 * @param conversationContext 对话上下文
 * @return 推断结果
 */
suspend fun inferNameFromConversation(
    strangerId: String,
    recentMessages: List<Message>,
    conversationContext: String = ""
): NameInferenceResult

/**
 * 名称推断结果
 */
data class NameInferenceResult(
    val inferred: Boolean,
    val candidates: List<NameCandidate>,
    val confidence: Float,
    val reasoning: String
)

data class NameCandidate(
    val name: String,
    val probability: Float,
    val evidence: List<String>
)
```

### NewPersonRegistrationUseCase (新人注册协调器)

**文件位置**: `domain/usecase/NewPersonRegistrationUseCase.kt`

```kotlin
/**
 * 注册新人（协调9个系统）
 * @param voiceprintProfile 声纹档案
 * @param recentMessages 最近的对话（用于名称推断）
 * @param context 上下文信息
 * @return 注册结果
 */
suspend fun registerNewPerson(
    voiceprintProfile: VoiceprintProfile,
    recentMessages: List<Message> = emptyList(),
    context: String = ""
): RegistrationResult

/**
 * 注册结果
 */
data class RegistrationResult(
    val success: Boolean,
    val personId: String,
    val characterId: String?,
    val displayName: String,
    val isStranger: Boolean,
    val checklist: RegistrationChecklist,
    val message: String
)

/**
 * 注册清单（确保所有系统都被更新）
 */
data class RegistrationChecklist(
    // P0: 核心系统
    var voiceprintRegistered: Boolean = false,
    var characterBookUpdated: Boolean = false,
    var socialRelationCreated: Boolean = false,

    // 名称推断
    var nameInferred: Boolean = false,
    var inferredName: String? = null,
    var nameConfidence: Float = 0f,

    // P1-P3: 其他系统
    var memorySystemInitialized: Boolean = false,
    var relationshipGraphUpdated: Boolean = false,
    var thirdPartyRelationsRecorded: Boolean = false,
    var worldBookUpdated: Boolean = false,
    var emotionTriggered: Boolean = false
)
```

这些接口提供了对小光AI助手系统所有核心功能的完整访问，支持复杂的智能交互和个性化服务。