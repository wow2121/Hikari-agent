# 小光AI助手 - 配置和使用指南

## 概述

本文档详细说明小光AI助手的配置参数、使用方法和部署指南，帮助用户正确配置和使用系统。

## 构建配置

### Gradle配置

**文件位置**: `app/build.gradle.kts`

#### 主要依赖配置

```kotlin
dependencies {
    // Android框架
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.lifecycle:lifecycle-runtime-ktx:2.7.0")
    implementation("androidx.activity:activity-compose:1.8.2")

    // Compose UI
    implementation(platform("androidx.compose:compose-bom:2023.10.01"))
    implementation("androidx.compose.ui:ui")
    implementation("androidx.compose.ui:ui-graphics")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.compose.material3:material3")

    // 依赖注入
    implementation("com.google.dagger:hilt-android:2.48.1")
    kapt("com.google.dagger:hilt-android-compiler:2.48.1")

    // 数据库
    implementation("io.realm.kotlin:library-base:1.11.0")
    implementation("io.realm.kotlin:library-sync:1.11.0")

    // 网络请求
    implementation("com.squareup.retrofit2:retrofit:2.9.0")
    implementation("com.squareup.retrofit2:converter-gson:2.9.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")

    // 语音技术
    implementation("ai.picovoice:porcupine-android:3.0.2")
    implementation("com.alphacephei:vosk-android:0.3.47")
    implementation("com.microsoft.onnxruntime:onnxruntime-android:1.16.3")
}
```

#### 编译配置

```kotlin
android {
    compileSdk = 34

    defaultConfig {
        applicationId = "com.xiaoguang.assistant"
        minSdk = 26
        targetSdk = 34
        versionCode = 1
        versionName = "1.0.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
        vectorDrawables {
            useSupportLibrary = true
        }
    }

    buildTypes {
        release {
            isMinifyEnabled = true
            isShrinkResources = true
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
        debug {
            isDebuggable = true
            applicationIdSuffix = ".debug"
        }
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    kotlinOptions {
        jvmTarget = "17"
    }
    buildFeatures {
        compose = true
    }
    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.4"
    }
    packaging {
        resources {
            excludes += "/META-INF/{AL2.0,LGPL2.1}"
        }
    }
}
```

## 心流系统配置

### FlowConfig配置

**文件位置**: `domain/flow/model/FlowConfig.kt`

#### 基础配置参数

```kotlin
data class FlowConfig(
    // 基础循环间隔 (毫秒)
    val baseIntervalMs: Long = 3000,

    // 发言阈值配置
    val speakThresholds: Map<PersonType, Float> = mapOf(
        PersonType.OWNER to 0.65f,    // 主人阈值
        PersonType.FRIEND to 0.75f,   // 朋友阈值
        PersonType.STRANGER to 0.85f  // 陌生人阈值
    ),

    // 最大发言占比 (0.0-1.0)
    val maxSpeakPercentage: Float = 0.15f,

    // 人格类型
    val personalityType: PersonalityType = PersonalityType.BALANCED,

    // 思考深度配置
    val thinkingDepth: ThinkingDepth = ThinkingDepth.MODERATE,

    // 情感敏感度
    val emotionSensitivity: Float = 0.7f,

    // 社交活跃度
    val socialActiveness: Float = 0.6f,

    // 记忆重要性权重
    val memoryImportanceWeights: MemoryWeights = MemoryWeights.default(),

    // 工具调用配置
    val toolCallConfig: ToolCallConfig = ToolCallConfig.default()
)
```

#### 人格类型配置

```kotlin
enum class PersonalityType {
    INTROVERTED_SHYY,  // 内向害羞
    BALANCED,          // 平衡
    OUTGOING_LIVELY,   // 外向活泼
    PROFESSIONAL_RESTRAINED  // 专业克制
}

// 每种人格类型的详细配置
val personalityConfigs = mapOf(
    PersonalityType.INTROVERTED_SHYY to PersonalityConfig(
        speakThresholdMultiplier = 1.2f,
        thinkingDepthMultiplier = 1.3f,
        emotionSensitivityMultiplier = 1.1f,
        socialActivenessMultiplier = 0.7f
    ),
    PersonalityType.BALANCED to PersonalityConfig(
        speakThresholdMultiplier = 1.0f,
        thinkingDepthMultiplier = 1.0f,
        emotionSensitivityMultiplier = 1.0f,
        socialActivenessMultiplier = 1.0f
    ),
    PersonalityType.OUTGOING_LIVELY to PersonalityConfig(
        speakThresholdMultiplier = 0.8f,
        thinkingDepthMultiplier = 0.9f,
        emotionSensitivityMultiplier = 1.2f,
        socialActivenessMultiplier = 1.3f
    ),
    PersonalityType.PROFESSIONAL_RESTRAINED to PersonalityConfig(
        speakThresholdMultiplier = 1.1f,
        thinkingDepthMultiplier = 1.2f,
        emotionSensitivityMultiplier = 0.9f,
        socialActivenessMultiplier = 0.8f
    )
)
```

#### 思考深度配置

```kotlin
enum class ThinkingDepth {
    SHALLOW,    // 浅层思考
    MODERATE,   // 中等思考
    DEEP        // 深度思考
}

val thinkingDepthConfigs = mapOf(
    ThinkingDepth.SHALLOW to ThinkingConfig(
        maxThoughts = 3,
        thoughtComplexity = 0.5f,
        reflectionDepth = 0.3f
    ),
    ThinkingDepth.MODERATE to ThinkingConfig(
        maxThoughts = 5,
        thoughtComplexity = 0.7f,
        reflectionDepth = 0.6f
    ),
    ThinkingDepth.DEEP to ThinkingConfig(
        maxThoughts = 8,
        thoughtComplexity = 0.9f,
        reflectionDepth = 0.8f
    )
)
```

## 记忆系统配置

### 记忆存储配置

**文件位置**: `domain/memory/config/MemoryConfig.kt`

```kotlin
data class MemoryConfig(
    // 记忆存储配置
    val storageConfig: StorageConfig = StorageConfig.default(),

    // 记忆检索配置
    val retrievalConfig: RetrievalConfig = RetrievalConfig.default(),

    // 记忆重构配置
    val reconstructionConfig: ReconstructionConfig = ReconstructionConfig.default(),

    // 记忆评估配置
    val evaluationConfig: EvaluationConfig = EvaluationConfig.default()
)

data class StorageConfig(
    val maxMemoriesPerCategory: Int = 1000,
    val autoCleanupEnabled: Boolean = true,
    val cleanupThreshold: Int = 800,
    val backupIntervalHours: Int = 24
)

data class RetrievalConfig(
    val defaultLimit: Int = 50,
    val semanticSearchEnabled: Boolean = true,
    val temporalSearchEnabled: Boolean = true,
    val emotionalSearchEnabled: Boolean = true,
    val cacheEnabled: Boolean = true,
    val cacheSize: Int = 100
)

data class ReconstructionConfig(
    val autoReconstructionEnabled: Boolean = true,
    val conflictDetectionThreshold: Float = 0.7f,
    val maxReconstructionAttempts: Int = 3,
    val llmAssistedReconstruction: Boolean = true
)
```

### 记忆评分权重配置

```kotlin
data class MemoryWeights(
    val relevanceWeight: Float = 0.4f,
    val importanceWeight: Float = 0.3f,
    val recencyWeight: Float = 0.2f,
    val emotionalWeight: Float = 0.1f
) {
    companion object {
        fun default(): MemoryWeights = MemoryWeights()
    }
}
```

## 社交系统配置

### 社交关系配置

**文件位置**: `domain/social/config/SocialConfig.kt`

```kotlin
data class SocialConfig(
    // 关系强度配置
    val relationshipConfig: RelationshipConfig = RelationshipConfig.default(),

    // 社交影响配置
    val socialImpactConfig: SocialImpactConfig = SocialImpactConfig.default(),

    // 第三方关系配置
    val thirdPartyConfig: ThirdPartyConfig = ThirdPartyConfig.default()
)

data class RelationshipConfig(
    val decayRate: Float = 0.01f,  // 关系衰减率 (每天)
    val maxIntimacy: Float = 1.0f,
    val minIntimacy: Float = 0.0f,
    val interactionImpactWeights: Map<InteractionType, Float> = mapOf(
        InteractionType.POSITIVE_CONVERSATION to 0.1f,
        InteractionType.DEEP_CONVERSATION to 0.15f,
        InteractionType.HELPFUL_ACTION to 0.2f,
        InteractionType.NEGATIVE_INTERACTION to -0.1f
    )
)

data class SocialImpactConfig(
    val environmentImpactEnabled: Boolean = true,
    val groupDynamicAnalysis: Boolean = true,
    val socialNormConsideration: Boolean = true
)

data class ThirdPartyConfig(
    val extractionEnabled: Boolean = true,
    val confidenceThreshold: Float = 0.7f,
    val autoIntegration: Boolean = true
)
```

## 工具调用配置

### MCP工具配置

**文件位置**: `domain/tools/config/ToolConfig.kt`

```kotlin
data class ToolCallConfig(
    // 工具调用限制
    val maxConcurrentCalls: Int = 3,
    val timeoutSeconds: Long = 30,
    val retryAttempts: Int = 2,

    // 工具选择配置
    val toolSelectionStrategy: ToolSelectionStrategy = ToolSelectionStrategy.SMART,
    val confidenceThreshold: Float = 0.6f,

    // 安全配置
    val securityEnabled: Boolean = true,
    val allowedDomains: Set<String> = setOf(
        "weather.com",
        "calendar.google.com",
        "news.api.org"
    )
)

enum class ToolSelectionStrategy {
    RANDOM,      // 随机选择
    CONFIDENCE,  // 基于置信度
    SMART        // 智能选择
}
```

## 环境配置

### 数据库服务器部署

**服务器端部署脚本位置**: `server-native/`

#### Windows 服务器部署步骤

1. **准备环境**
   - Python 3.10+（用于 ChromaDB）
   - Java 17+（用于 Neo4j）
   - Windows Server 或 Windows 10/11

2. **运行安装脚本**
   ```bash
   cd server-native
   1-install.bat  # 自动安装 ChromaDB 和 Neo4j
   ```

3. **启动服务**
   ```bash
   2-start-services.bat  # 启动所有服务
   ```

4. **获取连接信息**
   服务启动后会显示：
   ```
   ChromaDB: http://YOUR_IP:8000
   Neo4j HTTP: http://YOUR_IP:7474
   Neo4j Bolt: bolt://YOUR_IP:7687
   ```

### 应用配置

#### 数据库连接配置

**文件位置**: `app/src/main/java/com/xiaoguang/assistant/core/config/AppConfigManager.kt`

修改以下配置为你的服务器地址：

```kotlin
/**
 * Neo4j图数据库配置
 */
val neo4jBaseUrl: String = "http://YOUR_SERVER_IP:7474"

/**
 * Chroma向量数据库配置
 */
val chromaBaseUrl: String = "http://YOUR_SERVER_IP:8000"
```

**示例**（如果服务器 IP 是 192.168.1.100）：
```kotlin
val neo4jBaseUrl: String = "http://192.168.1.100:7474"
val chromaBaseUrl: String = "http://192.168.1.100:8000"
```

## 使用指南

### 1. 初始设置

#### 权限配置

在 `AndroidManifest.xml` 中需要以下权限：

```xml
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
```

#### API密钥和数据库认证配置

**文件位置**: `local.properties`

在项目根目录的 `local.properties` 文件中配置：

```properties
# Android SDK 路径（自动生成）
sdk.dir=C\:\\Users\\YOUR_USERNAME\\AppData\\Local\\Android\\Sdk

# Silicon Flow API 配置（必需）
SILICON_FLOW_API_KEY=your_silicon_flow_api_key_here

# Neo4j 数据库认证（必需）
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=xiaoguang123
NEO4J_DATABASE=neo4j
```

**重要提示**：
- `SILICON_FLOW_API_KEY`: 从 https://siliconflow.cn 获取
- Neo4j 默认密码在服务器安装时已设置为 `xiaoguang123`
- 修改配置后需要重新编译项目：`gradlew.bat clean assembleDebug`

### 2. 功能启用

#### 语音唤醒功能

```kotlin
// 初始化语音唤醒
val wakeWordDetector = Porcupine.Builder()
    .setAccessKey("your_porcupine_access_key")
    .setKeywordPath("xiaoguang_wake_word.ppn")
    .build(context)

// 启动监听
wakeWordDetector.start()
```

#### 离线语音识别

```kotlin
// 初始化语音识别
val model = Model("path/to/vosk/model")
val recognizer = Recognizer(model, 16000.0f)

// 开始识别
recognizer.acceptWaveForm(audioData, audioData.size)
```

### 3. 个性化配置

#### 修改人格类型

```kotlin
// 在应用设置中修改人格类型
val newConfig = FlowConfig(
    personalityType = PersonalityType.OUTGOING_LIVELY,
    emotionSensitivity = 0.8f,
    socialActiveness = 0.9f
)

flowSystem.updateConfig(newConfig)
```

#### 调整发言阈值

```kotlin
// 降低对主人的发言阈值
val newThresholds = mapOf(
    PersonType.OWNER to 0.5f,
    PersonType.FRIEND to 0.7f,
    PersonType.STRANGER to 0.8f
)

val updatedConfig = flowConfig.copy(speakThresholds = newThresholds)
```

### 4. 数据管理

#### 记忆备份和恢复

```kotlin
// 备份记忆数据
memorySystem.exportMemories("backup/memories.json")

// 恢复记忆数据
memorySystem.importMemories("backup/memories.json")
```

#### 清除缓存数据

```kotlin
// 清除所有缓存
memorySystem.clearCache()
socialSystem.clearCache()
knowledgeSystem.clearCache()
```

### 5. 调试和监控

#### 启用调试模式

```kotlin
// 在开发环境中启用详细日志
LogConfig.enableDebugMode(true)

// 启用性能监控
PerformanceMonitor.enable(true)
```

#### 查看系统状态

```kotlin
// 获取系统状态信息
val systemStatus = assistantSystem.getSystemStatus()

println("心流循环运行: ${systemStatus.flowRunning}")
println("记忆数量: ${systemStatus.memoryCount}")
println("社交关系数量: ${systemStatus.relationshipCount}")
println("工具调用次数: ${systemStatus.toolCallCount}")
```

## 完整配置流程

### 快速配置指南

#### 第一步：部署服务器端数据库

1. 在 Windows 服务器上运行 `server-native/1-install.bat`
2. 安装完成后运行 `2-start-services.bat` 启动服务
3. 记录显示的服务器 IP 地址（例如：192.168.1.100）

#### 第二步：配置 Android 应用

1. **修改数据库连接地址**

   编辑 `app/src/main/java/com/xiaoguang/assistant/core/config/AppConfigManager.kt`：
   ```kotlin
   val neo4jBaseUrl: String = "http://192.168.1.100:7474"
   val chromaBaseUrl: String = "http://192.168.1.100:8000"
   ```

2. **配置认证信息**

   编辑 `local.properties`：
   ```properties
   SILICON_FLOW_API_KEY=sk-xxxxxxxxxxxxx
   NEO4J_USERNAME=neo4j
   NEO4J_PASSWORD=xiaoguang123
   NEO4J_DATABASE=neo4j
   ```

3. **重新编译项目**
   ```bash
   gradlew.bat clean
   gradlew.bat assembleDebug
   ```

#### 第三步：安装并测试

1. 将编译好的 APK 安装到 Android 设备
2. 启动应用，进入"知识管理"页面
3. 查看数据库连接状态，确认 ChromaDB 和 Neo4j 都显示"已连接"

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查服务器 IP 地址是否正确
   - 确认服务器防火墙允许 7474、7687、8000 端口
   - 验证服务器端服务是否正常运行

2. **语音唤醒不工作**
   - 检查麦克风权限
   - 验证唤醒词模型文件
   - 检查Porcupine访问密钥

2. **AI服务连接失败**
   - 验证网络连接
   - 检查API密钥配置
   - 查看服务状态

3. **记忆存储错误**
   - 检查存储空间
   - 验证数据库连接
   - 查看日志文件

4. **性能问题**
   - 减少同时运行的模块
   - 调整心流循环间隔
   - 清理缓存数据

### 日志查看

日志文件位置：`/data/data/com.xiaoguang.assistant/files/logs/`

关键日志文件：
- `flow_system.log` - 心流系统日志
- `memory_system.log` - 记忆系统日志
- `social_system.log` - 社交系统日志
- `tool_system.log` - 工具系统日志

通过这些配置和使用指南，用户可以充分发挥小光AI助手的功能，并根据个人需求进行个性化定制。